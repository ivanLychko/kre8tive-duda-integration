<!DOCTYPE html>
<html>

<head>
    <title>Choose Your Subscription</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.cdnfonts.com/css/work-sans" rel="stylesheet">
    <style>
        .subscription-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .back-button:hover {
            background-color: #f0f0f0;
            transform: scale(1.1);
        }

        .back-icon {
            width: 20px;
            height: 20px;
            fill: #333;
            transition: fill 0.3s ease;
        }

        .back-button:hover .back-icon {
            fill: #007bff;
        }

        .plan-type {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .plan-type h2 {
            margin: 0;
            color: #333;
        }

        .plus-option {
            display: none !important;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .plus-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .plus-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .pricing-options {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pricing-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            max-width: 400px;
            width: 100%;
        }

        .billing-switcher {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        .switcher-toggle {
            position: relative;
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .switcher-toggle.active {
            background-color: #007bff;
        }

        .switcher-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .switcher-toggle.active .switcher-slider {
            transform: translateX(20px);
        }

        .pricing-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .pricing-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .pricing-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .price {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }

        .period {
            color: #666;
            font-size: 14px;
        }

        .features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .features li {
            padding: 5px 0;
            color: #555;
        }

        .features li:before {
            content: "✓ ";
            color: #28a745;
            font-weight: bold;
        }

        .subscribe-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .subscribe-btn:hover {
            background: #0056b3;
        }

        .subscribe-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="subscription-container">
            <button class="back-button" onclick="goBack()" title="Go back">
                <svg class="back-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                </svg>
            </button>
            <h1 class="preview">Publish Your Site</h1>
            <h2 class="info">Choose your subscription plan to publish your website.</h2>

            <div class="plan-type">
                <h2>
                    <% if (subscriptionInfo.type==='infinity' ) { %>
                        Elite Plan
                        <% } else if (subscriptionInfo.type==='pro' ) { %>
                            Advance Plan
                            <% } else { %>
                                Standard Plan
                                <% } %>
                </h2>
                <p>Based on your website configuration</p>
            </div>

            <div class="plus-option">
                <label>
                    <input type="checkbox" id="plusCheckbox" onchange="togglePlus()">
                    <span>Include Plus features (Additional services and support)</span>
                </label>
            </div>

            <div class="pricing-options" id="pricingOptions">
                <div class="loading">Loading pricing options...</div>
            </div>
        </div>
    </div>

    <script>
        function goBack() {
            window.history.back();
        }

        let currentPrices = {
            monthly: <%- JSON.stringify(monthlyPrices || []) %>,
            yearly: <%- JSON.stringify(yearlyPrices || []) %>
        };

        let selectedPeriod = 'month';
        let includePlus = false;
        const sitename = '<%= sitename %>';
        const sessionId = '<%= sessionId %>';

        function togglePlus() {
            includePlus = document.getElementById('plusCheckbox').checked;
            loadPricingOptions();
        }

        function loadPricingOptions() {
            const loadingDiv = document.getElementById('pricingOptions');
            loadingDiv.innerHTML = '<div class="loading">Loading pricing options...</div>';

            fetch(`/get-available-products?sitename=${sitename}&includePlus=${includePlus}`)
                .then(response => response.json())
                .then(data => {
                    currentPrices = {
                        monthly: data.monthlyPrices,
                        yearly: data.yearlyPrices
                    };
                    renderPricingOptions();
                })
                .catch(error => {
                    console.error('Error loading pricing options:', error);
                    loadingDiv.innerHTML = '<div class="loading">Error loading pricing options. Please try again.</div>';
                });
        }

        function renderPricingOptions() {
            const container = document.getElementById('pricingOptions');

            if (currentPrices.monthly.length === 0 && currentPrices.yearly.length === 0) {
                container.innerHTML = '<div class="loading">No pricing options available for your configuration.</div>';
                return;
            }

            // Get the first available price (monthly or yearly)
            const monthlyPrice = currentPrices.monthly.length > 0 ? currentPrices.monthly[0] : null;
            const yearlyPrice = currentPrices.yearly.length > 0 ? currentPrices.yearly[0] : null;

            if (!monthlyPrice && !yearlyPrice) {
                container.innerHTML = '<div class="loading">No pricing options available for your configuration.</div>';
                return;
            }

            // Use the available price to get plan name
            const currentPrice = selectedPeriod === 'month' ? monthlyPrice : yearlyPrice;
            const planName = getPlanName(currentPrice);

            let html = `
                <div class="pricing-card">
                    <div class="billing-switcher">
                        <div class="switcher-toggle ${selectedPeriod === 'year' ? 'active' : ''}" onclick="toggleBillingPeriod(event)">
                            <div class="switcher-slider"></div>
                        </div>
                        <span>Annual</span>
                    </div>
                    <h3>${planName}</h3>
                    <div class="price">${getCurrentPrice()}</div>
                    <div class="period">${getCurrentPeriod()}</div>
                    <ul class="features">
                        <li>${planName}</li>
                        <li>${includePlus ? 'Plus features included' : 'Standard features'}</li>
                        <li>Cancel anytime</li>

                        <% if (subscriptionInfo && subscriptionInfo.hasShop) { %>
                            <li><b>Everything in Business Website</b></li>
                            <li>Specialty Store & Product Pages</li>
                            <li>Product Catalog Management</li>
                            <li>Product Options & Variations</li>
                            <li>Product Categories & Subcategories</li>
                            <li>Cross-Store Tax Settings</li>
                            <li>3rd Party Shipping Providers</li>
                            <li>Customizable Shipping Rules</li>
                            <li>Printable Shipping Labels</li>
                            <li>Product SEO optimization</li>
                            <li>Discount & Promo Codes</li>
                            <li>Paid Memberships</li>
                            <li>Info Management via CSV</li>
                            <li>Custom Product Fields</li>
                            <li>Store Search</li>
                            <li>Abandoned Carts</li>
                            <li>Store Login for Buyers</li>
                            <li>...and more!</li>
                        <% } else { %>
                            <li>Drag & Drop Editor</li>
                            <li>SSL Certificate</li>
                            <li>Built-in Analytics</li>
                            <li>On-the-Go Editing</li>
                            <li>Amazon Cloud Hosting</li>
                            <li>Unlimited Bandwidth</li>
                            <li>Multi-Language Platform</li>
                            <li>Optimized Images</li>
                            <li>90+ Speed Ranking</li>  
                            <li>Automatic Updates</li>
                            <li>Automatic Backups</li>
                            <li>Unlimited File Space</li>
                            <li>Unlimited Pages</li>
                            <li>SEO Recommendations</li>
                        <% } %>

                        
                    </ul>
                    <button class="subscribe-btn" onclick="subscribeToCurrentPlan()">
                        Subscribe ${selectedPeriod === 'month' ? 'Monthly' : 'Yearly'}
                    </button>
                </div>
            `;

            container.innerHTML = html;
        }

        function toggleBillingPeriod(event) {
            event.stopPropagation(); // Prevent card click
            selectedPeriod = selectedPeriod === 'month' ? 'year' : 'month';
            renderPricingOptions();
        }

        function getCurrentPrice() {
            const monthlyPrice = currentPrices.monthly.length > 0 ? currentPrices.monthly[0] : null;
            const yearlyPrice = currentPrices.yearly.length > 0 ? currentPrices.yearly[0] : null;

            if (selectedPeriod === 'month' && monthlyPrice) {
                return `$${(monthlyPrice.unit_amount / 100).toFixed(0)}`;
            } else if (selectedPeriod === 'year' && yearlyPrice) {
                return `$${(yearlyPrice.unit_amount / 100).toFixed(0)}`;
            }

            return 'N/A';
        }

        function getCurrentPeriod() {
            if (selectedPeriod === 'month') {
                return 'per month';
            } else {
                const yearlyPrice = currentPrices.yearly.length > 0 ? currentPrices.yearly[0] : null;
                if (yearlyPrice) {
                    const monthlyEquivalent = (yearlyPrice.unit_amount / 100 / 12).toFixed(0);
                    return `per year ($${monthlyEquivalent}/month)`;
                }
                return 'per year';
            }
        }

        function subscribeToCurrentPlan() {
            const monthlyPrice = currentPrices.monthly.length > 0 ? currentPrices.monthly[0] : null;
            const yearlyPrice = currentPrices.yearly.length > 0 ? currentPrices.yearly[0] : null;

            if (selectedPeriod === 'month' && monthlyPrice) {
                subscribe(monthlyPrice.product, 'month');
            } else if (selectedPeriod === 'year' && yearlyPrice) {
                subscribe(yearlyPrice.product, 'year');
            }
        }

        function getPlanName(price) {
            const planName = price.name || 'Subscription Plan';
            return planName;
        }

        function subscribe(productId, period) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/create-checkout-session';
            form.target = '_blank'; // Открывает в новой вкладке

            const productInput = document.createElement('input');
            productInput.type = 'hidden';
            productInput.name = 'productId';
            productInput.value = productId;

            const siteInput = document.createElement('input');
            siteInput.type = 'hidden';
            siteInput.name = 'siteName';
            siteInput.value = sitename;

            const plusInput = document.createElement('input');
            plusInput.type = 'hidden';
            plusInput.name = 'includePlus';
            plusInput.value = includePlus;

            form.appendChild(productInput);
            form.appendChild(siteInput);
            form.appendChild(plusInput);

            document.body.appendChild(form);
            form.submit();
        }

        // Initial render
        renderPricingOptions();
    </script>
</body>

</html>
