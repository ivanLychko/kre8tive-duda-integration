<!DOCTYPE html>
<html>
<head>
    <title>Choose Your Subscription</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.cdnfonts.com/css/work-sans" rel="stylesheet">
    <style>
        .subscription-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .plan-type {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .plan-type h2 {
            margin: 0;
            color: #333;
        }

        .plus-option {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
        }

        .plus-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .plus-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .pricing-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .pricing-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pricing-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .pricing-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .pricing-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .price {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
        }

        .period {
            color: #666;
            font-size: 14px;
        }

        .features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .features li {
            padding: 5px 0;
            color: #555;
        }

        .features li:before {
            content: "✓ ";
            color: #28a745;
            font-weight: bold;
        }

        .subscribe-btn {
            width: 100%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .subscribe-btn:hover {
            background: #0056b3;
        }

        .subscribe-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="root">
        <div class="subscription-container">
            <h1 class="preview">Publish Your Site</h1>
            <h2 class="info">Choose your subscription plan to publish your website.</h2>

            <div class="plan-type">
                <h2>
                    <% if (subscriptionInfo.type==='infinity' ) { %>
                        Elite Plan
                        <% } else if (subscriptionInfo.type==='pro' ) { %>
                            Advance Plan
                            <% } else { %>
                                Standard Plan
                                <% } %>
                </h2>
                <p>Based on your website configuration</p>
            </div>

            <div class="plus-option">
                <label>
                    <input type="checkbox" id="plusCheckbox" onchange="togglePlus()">
                    <span>Include Plus features (Additional services and support)</span>
                </label>
            </div>

            <div class="pricing-options" id="pricingOptions">
                <div class="loading">Loading pricing options...</div>
            </div>
        </div>
    </div>

    <script>

        let currentPrices = {
            monthly: <%- JSON.stringify(monthlyPrices || []) %>,
            yearly: <%- JSON.stringify(yearlyPrices || []) %>
        };

        let selectedPeriod = 'month';
        let includePlus = false;
        const sitename = '<%= sitename %>';
        const sessionId = '<%= sessionId %>';

        function togglePlus() {
            includePlus = document.getElementById('plusCheckbox').checked;
            loadPricingOptions();
        }

        function loadPricingOptions() {
            const loadingDiv = document.getElementById('pricingOptions');
            loadingDiv.innerHTML = '<div class="loading">Loading pricing options...</div>';

            fetch(`/get-available-products?sitename=${sitename}&includePlus=${includePlus}`)
                .then(response => response.json())
                .then(data => {
                    currentPrices = {
                        monthly: data.monthlyPrices,
                        yearly: data.yearlyPrices
                    };
                    renderPricingOptions();
                })
                .catch(error => {
                    console.error('Error loading pricing options:', error);
                    loadingDiv.innerHTML = '<div class="loading">Error loading pricing options. Please try again.</div>';
                });
        }

        function renderPricingOptions() {
            const container = document.getElementById('pricingOptions');

            if (currentPrices.monthly.length === 0 && currentPrices.yearly.length === 0) {
                container.innerHTML = '<div class="loading">No pricing options available for your configuration.</div>';
                return;
            }

            let html = '';

            // Monthly option
            if (currentPrices.monthly.length > 0) {
                const monthlyPrice = currentPrices.monthly[0];
                html += `
          <div class="pricing-card ${selectedPeriod === 'month' ? 'selected' : ''}" onclick="selectPeriod('month')">
            <h3>Monthly</h3>
            <div class="price">$${(monthlyPrice.unit_amount / 100).toFixed(0)}</div>
            <div class="period">per month</div>
            <ul class="features">
              <li>${getPlanName(monthlyPrice)}</li>
              <li>${includePlus ? 'Plus features included' : 'Standard features'}</li>
              <li>Cancel anytime</li>
            </ul>
            <button class="subscribe-btn" onclick="subscribe('${monthlyPrice.product}', 'month')">
              Subscribe Monthly
            </button>
          </div>
        `;
            }

            // Yearly option
            if (currentPrices.yearly.length > 0) {
                const yearlyPrice = currentPrices.yearly[0];
                const monthlyEquivalent = (yearlyPrice.unit_amount / 100 / 12).toFixed(0);
                html += `
          <div class="pricing-card ${selectedPeriod === 'year' ? 'selected' : ''}" onclick="selectPeriod('year')">
            <h3>Yearly</h3>
            <div class="price">$${(yearlyPrice.unit_amount / 100).toFixed(0)}</div>
            <div class="period">per year ($${monthlyEquivalent}/month)</div>
            <ul class="features">
              <li>${getPlanName(yearlyPrice)}</li>
              <li>${includePlus ? 'Plus features included' : 'Standard features'}</li>
              <li>Cancel anytime</li>
            </ul>
            <button class="subscribe-btn" onclick="subscribe('${yearlyPrice.product}', 'year')">
              Subscribe Yearly
            </button>
          </div>
        `;
            }

            container.innerHTML = html;
        }

        function selectPeriod(period) {
            selectedPeriod = period;
            renderPricingOptions();
        }

        function getPlanName(price) {
            const planName = price.name || 'Subscription Plan';
            return planName;
        }

        function subscribe(productId, period) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/create-checkout-session';
            form.target = '_blank'; // Открывает в новой вкладке

            const productInput = document.createElement('input');
            productInput.type = 'hidden';
            productInput.name = 'productId';
            productInput.value = productId;

            const siteInput = document.createElement('input');
            siteInput.type = 'hidden';
            siteInput.name = 'siteName';
            siteInput.value = sitename;

            const plusInput = document.createElement('input');
            plusInput.type = 'hidden';
            plusInput.name = 'includePlus';
            plusInput.value = includePlus;

            form.appendChild(productInput);
            form.appendChild(siteInput);
            form.appendChild(plusInput);

            document.body.appendChild(form);
            form.submit();
        }

        // Initial render
        renderPricingOptions();
    </script>
</body>

</html>
